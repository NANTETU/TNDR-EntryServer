<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ライセンスキー生成</title>
  <script src="https://openfpcdn.io/fingerprintjs/v3"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 30px; }
    #licenseKey { margin-top: 20px; font-size: 20px; white-space: pre-wrap; }
    button { font-size: 18px; padding: 10px 20px; margin: 10px; }
  </style>
</head>
<body>
  <h1>ライセンスキー生成ツール</h1>
  <button id="generateBtn" onclick="generateLicenseKey()">ライセンスキー生成</button>
  <button id="copyBtn" style="display:none;" onclick="copyLicenseKey()">コピー</button>
  <p id="licenseKey"></p>

  <script>
    let fingerprint = null;

    // 指紋取得
    FingerprintJS.load().then(fp => {
      fp.get().then(result => {
        fingerprint = result.visitorId;
        console.log("visitorId:", fingerprint);
      });
    });

    // ライセンスキー生成関数
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // ライセンスキー生成＆送信
    function generateLicenseKey() {
      if (!fingerprint) {
        alert("識別中…もうちょい待ってな！");
        return;
      }

      const licenseKey = generateUUID();

      fetch("https://script.google.com/macros/s/AKfycbz2B6-jXMxbLNUY-QqydbLRF9CXkaId6qjjhTL5Lbs5RBjnqcHHkYrsh72FEpLdqIoeug/exec", {
        method: "POST",
        body: new URLSearchParams({
          userId: fingerprint,
          licenseKey: licenseKey
        })
      })
      .then(res => res.text())
      .then(res => {
        if (res === "ALREADY_EXISTS") {
          alert("もうライセンスキー作っとるで！");
        } else {
          document.getElementById("licenseKey").innerText = `あなたのライセンスキー:\n${res}`;
          document.getElementById("generateBtn").style.display = "none";
          document.getElementById("copyBtn").style.display = "inline-block";
        }
      })
      .catch(err => {
        alert("エラー発生したで！\n" + err);
      });
    }

    // コピー機能
    function copyLicenseKey() {
      const text = document.getElementById("licenseKey").innerText;
      navigator.clipboard.writeText(text).then(() => {
        alert("コピーしたで！");
      });
    }
  </script>
</body>
</html>
